from elasticsearch import Elasticsearch
from fastapi import APIRouter
from fastapi.responses import JSONResponse
from os import getenv

router = APIRouter(tags=['All CVE page'])

es_url = getenv("ELASTICSEARCH_URL")
api_key = getenv("ELASTICSEARCH_API_KEY")

es = Elasticsearch(es_url, api_key=api_key)

@router.get('/get/new', response_class=JSONResponse)
def get_new():
    """Повертає 10 найновіших CVE."""
    INDEX = "cve_index"  

    query = {
        "sort": [
            {"dateAdded": {"order": "desc"}}
        ],
        "size": 10  
    }

    response = es.search(index=INDEX, body=query)
    hits = response["hits"]["hits"]
    if not hits:
        return {"message": "No CVEs found."}
    recent_cve = [hit["_source"] for hit in hits]


    return {"recent_cves": recent_cve}
