from elasticsearch import Elasticsearch
from fastapi import APIRouter
from fastapi.responses import JSONResponse
from datetime import datetime, timedelta
from os import getenv

router = APIRouter(tags=['All CVE page'])

es_url = getenv("ELASTICSEARCH_URL")
api_key = getenv("ELASTICSEARCH_API_KEY")

es = Elasticsearch(es_url, api_key=api_key)

@router.get('/get/all', response_class=JSONResponse)
def get_all_cve():
    INDEX = "cve_index"
    date_now = "2024-11-26"  # datetime.now()
    date_now = datetime.strptime(date_now, "%Y-%m-%d")
    cut_date = date_now - timedelta(days=5)

    query = {
        "query": {
            "range": {
                "dateAdded": {
                    "gte": cut_date,
                    "lte": date_now.strftime("%Y-%m-%d")
                }
            }
        },
        "size": 40
    }

    try:
        response = es.search(index=INDEX, body=query)
        hits = response["hits"]["hits"]
        if not hits:
            return {"message": "No CVEs found for the last 5 days."}
        cve_recent = [hit["_source"] for hit in hits]
    except Exception as e:
        return {"error": f"Error accessing Elasticsearch: {str(e)}"}

    return {"cves": cve_recent}
