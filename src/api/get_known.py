from elasticsearch import Elasticsearch
from fastapi import APIRouter
from fastapi.responses import JSONResponse
from os import getenv

router = APIRouter(tags=['Get known page'])

es_url = getenv("ELASTICSEARCH_URL")
api_key = getenv("ELASTICSEARCH_API_KEY")

es = Elasticsearch(es_url, api_key=api_key)


@router.get('/get/known', response_class=JSONResponse)
def get_known_cve():
    """Повертає до 10 CVE з 'Known Ransomware Campaign Use'."""
    INDEX = "cve_index"  

    query = {
        "query": {
            "match": {
                "knownRansomwareCampaignUse": "Known"
            }
        },
        "size": 10 
    }

    response = es.search(index=INDEX, body=query)
    hits = response["hits"]["hits"]
    if not hits:
        return {"message": "No known ransomware CVEs found."}
    cve_known = [hit["_source"] for hit in hits]


    return {"cves": cve_known}
