from elasticsearch import Elasticsearch
from fastapi import APIRouter, Query
from fastapi.responses import JSONResponse
from os import getenv

router = APIRouter(tags=['All CVE page'])

es_url = getenv("ELASTICSEARCH_URL")
api_key = getenv("ELASTICSEARCH_API_KEY")

es = Elasticsearch(es_url, api_key=api_key)

@router.get('/get', response_class=JSONResponse)
def get_query(query: str = ""):
    """Шукає CVE, що відповідають запиту, та повертає у форматі JSON."""
    INDEX = "cve_index"  

    if not query:
        return {"message": "No query specified"}


    query_body = {
        "query": {
            "multi_match": {
                "query": query,
                "fields": ["*"],  
                "operator": "and" 
            }
        }
    }

    response = es.search(index=INDEX, body=query_body)
    hits = response["hits"]["hits"]
    if not hits:
        return {"message": "No matching CVEs found."}
    matching_cves = [hit["_source"] for hit in hits]

    return {"matching_cves": matching_cves}
