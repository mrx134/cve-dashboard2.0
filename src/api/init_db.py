from elasticsearch import Elasticsearch
from fastapi import APIRouter
import json
import os

router = APIRouter(tags=["db init page"])

@router.get("/initdb")
def init_database():
    FILE_PATH = "resourses/known_exploited_vulnerabilities.json"
    INDEX = "cve_index"

    es_url = os.getenv("ELASTICSEARCH_URL")
    api_key = os.getenv("ELASTICSEARCH_API_KEY")

    # Підключення до Elasticsearch
    es = Elasticsearch(es_url, api_key=api_key)

    if not es.indices.exists(index=INDEX):
        es.indices.create(index=INDEX)

    with open(FILE_PATH, "r", encoding="utf-8") as file:
        data = json.load(file)

    vulnerabilities = data.get("vulnerabilities", [])

    if es.count(index=INDEX)["count"] != len(vulnerabilities):
        es.delete_by_query(index=INDEX, body={"query": {"match_all": {}}})
        for idx, vuln in enumerate(vulnerabilities, start=1):
            es.index(index=INDEX, id=f"vuln-{idx}", document=vuln)
        return {"status": "Database updated", "total": len(vulnerabilities)}
    
    return {"status": "Database is already up-to-date"}
